name: Reliable Policy Delivery

on:
  release:
    types: [published]

env:
  S3_BUCKET: ${{ vars.S3_BUCKET_NAME }}
  POLICY_HUB_API_URL: ${{ vars.POLICY_HUB_API_URL }}
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  setup-delivery:
    name: Setup Delivery Environment
    runs-on: ubuntu-latest
    outputs:
      baseline-sha: ${{ steps.baseline.outputs.sha }}
      head-sha: ${{ steps.head.outputs.sha }}
      release-tag: ${{ steps.release.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup environment
        run: |
          echo "ğŸ”§ Setting up delivery environment"

          # Make scripts executable
          chmod +x scripts/validate-policy.sh
          chmod +x scripts/prepare-zip.sh

          # Install required tools
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Get baseline SHA
        id: baseline
        run: |
          baseline_sha=$(cat .state/baseline.sha)
          echo "ğŸ“ Baseline SHA: $baseline_sha"
          echo "sha=$baseline_sha" >> $GITHUB_OUTPUT

      - name: Get head SHA
        id: head
        run: |
          head_sha=${{ github.sha }}
          echo "ğŸ¯ Head SHA: $head_sha"
          echo "sha=$head_sha" >> $GITHUB_OUTPUT

      - name: Get release info
        id: release
        run: |
          release_tag=${{ github.event.release.tag_name }}
          echo "ğŸ·ï¸  Release tag: $release_tag"
          echo "tag=$release_tag" >> $GITHUB_OUTPUT

  detect-changes:
    name: Detect Changed Policies
    needs: setup-delivery
    runs-on: ubuntu-latest
    outputs:
      changed-folders: ${{ steps.detect.outputs.changed-folders }}
      folder-count: ${{ steps.detect.outputs.folder-count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Detect changed folders
        id: detect
        uses: ./.github/actions/detect-changes
        with:
          baseline-sha: ${{ needs.setup-delivery.outputs.baseline-sha }}
          head-sha: ${{ needs.setup-delivery.outputs.head-sha }}

  check-delivery-status:
    name: Check Delivery Status
    needs: [setup-delivery, detect-changes]
    runs-on: ubuntu-latest
    outputs:
      pending-folders: ${{ steps.status.outputs.pending-folders }}
      skipped-folders: ${{ steps.status.outputs.skipped-folders }}
      pending-count: ${{ steps.status.outputs.pending-count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Check delivery eligibility
        id: status
        uses: ./.github/actions/check-delivery-status
        with:
          changed-folders: ${{ needs.detect-changes.outputs.changed-folders }}
          baseline-sha: ${{ needs.setup-delivery.outputs.baseline-sha }}

  deliver-policies:
    name: Deliver Policies
    needs: [setup-delivery, check-delivery-status]
    if: needs.check-delivery-status.outputs.pending-count > 0
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        folder: ${{ fromJSON(needs.check-delivery-status.outputs.pending-folders) }}
      fail-fast: false  # Continue with other folders even if one fails
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup delivery environment
        run: |
          chmod +x scripts/validate-policy.sh
          chmod +x scripts/prepare-zip.sh
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deliver policy
        id: deliver
        uses: ./.github/actions/deliver-policy
        with:
          folder-path: ${{ matrix.folder }}
          s3-bucket: ${{ env.S3_BUCKET }}
          policy-hub-url: ${{ env.POLICY_HUB_API_URL }}
          repo-url: ${{ github.server_url }}/${{ github.repository }}
          policy-hub-api-key: ${{ secrets.POLICY_HUB_API_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update delivery state
        if: steps.deliver.outputs.success == 'true'
        uses: ./.github/actions/update-state
        with:
          folder-path: ${{ matrix.folder }}
          commit-sha: ${{ steps.deliver.outputs.commit-sha }}
          delivery-timestamp: ${{ github.event.release.published_at || github.event.head_commit.timestamp }}

  update-baseline:
    name: Update Baseline
    needs: [setup-delivery, deliver-policies]
    if: always() && needs.deliver-policies.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Update baseline SHA
        run: |
          new_baseline=${{ needs.setup-delivery.outputs.head-sha }}
          echo "ğŸ“ Updating baseline to: $new_baseline"
          echo "$new_baseline" > .state/baseline.sha

      - name: Commit state changes
        run: |
          if git diff --quiet .state/; then
            echo "ğŸ“‹ No state changes to commit"
            exit 0
          fi

          echo "ğŸ“ Committing delivery state updates"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .state/
          git commit -m "Update delivery state after release ${{ needs.setup-delivery.outputs.release-tag }}

          - Baseline updated to ${{ needs.setup-delivery.outputs.head-sha }}
          - Delivery state synchronized" || true

          git push origin ${{ github.event.release.target_commitish }} || true

  delivery-summary:
    name: Delivery Summary
    needs: [detect-changes, check-delivery-status, deliver-policies]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate delivery report
        run: |
          echo "ğŸ“Š Delivery Summary for Release ${{ github.event.release.tag_name }}"
          echo "=================================================="

          echo ""
          echo "ğŸ” Detection Results:"
          echo "  - Changed folders: ${{ needs.detect-changes.outputs.folder-count }}"

          echo ""
          echo "ğŸ“‹ Delivery Status:"
          echo "  - Pending delivery: ${{ needs.check-delivery-status.outputs.pending-count }}"
          echo "  - Skipped (already delivered): $(echo '${{ needs.check-delivery-status.outputs.skipped-folders }}' | jq '. | length')"

          echo ""
          echo "ğŸš€ Delivery Results:"
          if [ "${{ needs.deliver-policies.result }}" = "success" ]; then
            echo "  âœ… All deliveries completed successfully"
          elif [ "${{ needs.deliver-policies.result }}" = "failure" ]; then
            echo "  âŒ Some deliveries failed (will retry on next release)"
          elif [ "${{ needs.deliver-policies.result }}" = "skipped" ]; then
            echo "  â­ï¸  No deliveries needed"
          else
            echo "  âš ï¸  Delivery status unknown"
          fi

          echo ""
          echo "ğŸ”— Release: ${{ github.event.release.html_url }}"
          echo "ğŸ“… Published: ${{ github.event.release.published_at }}"