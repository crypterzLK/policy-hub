name: Batch Release

on:
  release:
    types: [published]

env:
  S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
  POLICY_HUB_API_URL: ${{ secrets.POLICY_HUB_API_URL }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  detect-versions:
    runs-on: ubuntu-latest
    outputs:
      new-versions: ${{ steps.detect.outputs.new-versions }}
      new-versions-json: ${{ steps.format.outputs.json }}
      version-count: ${{ steps.count.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Get last release tag
        id: last_release
        run: |
          echo "Fetching last release tag..."
          last_tag=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          echo "last_tag=$last_tag" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect new policy versions
        id: detect
        uses: ./.github/actions/detect-versions
        with:
          base-sha: ${{ steps.last_release.outputs.last_tag || github.event.release.target_commitish }}
          head-sha: ${{ github.sha }}

      - name: Format versions for matrix
        id: format
        run: |
          versions="${{ steps.detect.outputs.new-versions }}"
          json_array="[]"
          if [ -n "$versions" ]; then
            json_array="["
            first=true
            for version_path in $versions; do
              if [ "$first" = true ]; then
                first=false
              else
                json_array+=","
              fi
              policy=$(echo $version_path | cut -d'/' -f1)
              version=$(echo $version_path | cut -d'/' -f2)
              json_array+="{\"policy\":\"$policy\",\"version\":\"$version\"}"
            done
            json_array+="]"
          fi
          echo "json=$json_array" >> $GITHUB_OUTPUT

      - name: Count versions
        id: count
        run: |
          version_count=$(echo "${{ steps.detect.outputs.new-versions }}" | wc -w)
          echo "count=$version_count" >> $GITHUB_OUTPUT

  publish-policies:
    needs: detect-versions
    if: needs.detect-versions.outputs.version-count > 0
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        version-item: ${{ fromJSON(needs.detect-versions.outputs.new-versions-json) }}
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish policy version
        id: publish
        uses: ./.github/actions/publish-policy
        with:
          policy: ${{ matrix.version-item.policy }}
          version: ${{ matrix.version-item.version }}
          s3-bucket: ${{ secrets.S3_BUCKET_NAME }}
          policy-hub-url: ${{ secrets.POLICY_HUB_API_URL }}
          repo-url: ${{ github.server_url }}/${{ github.repository }}

      - name: Report result
        if: always()
        run: |
          if [[ "${{ steps.publish.outputs.success }}" == "true" ]]; then
            echo "✅ Successfully published ${{ matrix.version-item.policy }} ${{ matrix.version-item.version }}"
          else
            echo "❌ Failed to publish ${{ matrix.version-item.policy }} ${{ matrix.version-item.version }}"
            exit 1
          fi