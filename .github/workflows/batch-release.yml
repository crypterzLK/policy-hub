name: Release Delivery

on:
  release:
    types: [published]

jobs:
  setup-state:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup state
      run: |
        mkdir -p .state
        if [ ! -f .state/baseline.sha ]; then
          git rev-list --max-parents=0 HEAD > .state/baseline.sha
        fi
        if [ ! -f .state/delivered.json ]; then
          echo '{}' > .state/delivered.json
        fi
    - name: Commit initial state
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .state/
        git commit -m "Initialize delivery state" || true
        git push origin HEAD:main || true

  detect-folders:
    needs: setup-state
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.detect.outputs.folders }}
    steps:
    - uses: actions/checkout@v4
    - name: Detect changed folders
      id: detect
      run: |
        baseline=$(cat .state/baseline.sha)
        folders=$(git diff --name-only $baseline..HEAD | awk -F'/' '{print $1"/"$2"/"$3}' | sort -u | jq -R -s -c 'split("\n")[:-1]')
        echo "folders=$folders" >> $GITHUB_OUTPUT

  deliver:
    needs: detect-folders
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: ${{ fromJson(needs.detect-folders.outputs.folders) }}
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Check eligibility
      id: check
      run: |
        folder="${{ matrix.folder }}"
        latest_sha=$(git log -1 --format=%H -- $folder)
        delivered_sha=$(jq -r ".\"$folder\" // empty" .state/delivered.json)
        if [ "$latest_sha" != "$delivered_sha" ]; then
          echo "deliver=true" >> $GITHUB_OUTPUT
        else
          echo "deliver=false" >> $GITHUB_OUTPUT
        fi
    - name: Deliver folder
      if: steps.check.outputs.deliver == 'true'
      run: |
        folder="${{ matrix.folder }}"
        latest_sha=$(git log -1 --format=%H -- $folder)
        # API call to Policy Hub
        curl -X POST ${{ vars.POLICY_HUB_API_URL }}/sync \
          -H "Content-Type: application/json" \
          -d "{\"folder\": \"$folder\", \"commit\": \"$latest_sha\"}"
    - name: Update state on success
      if: steps.check.outputs.deliver == 'true' && success()
      run: |
        folder="${{ matrix.folder }}"
        latest_sha=$(git log -1 --format=%H -- $folder)
        jq ".\"$folder\" = \"$latest_sha\"" .state/delivered.json > .state/delivered.json.tmp && mv .state/delivered.json.tmp .state/delivered.json
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .state/delivered.json
        git commit -m "Update delivery state for ${{ matrix.folder }}" || true
        git push origin HEAD:main || true