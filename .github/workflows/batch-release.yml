name: Batch Release - Reliable Policy Delivery

on:
  release:
    types: [published]

concurrency:
  group: release-${{ github.event.release.tag_name }}
  cancel-in-progress: false

env:
  POLICY_HUB_API_URL: ${{ vars.POLICY_HUB_API_URL }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  MAX_PARALLEL: ${{ vars.MAX_PARALLEL || 3 }}

jobs:
  # Initialize baseline and state
  initialize:
    name: Initialize Baseline & State
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      baseline-sha: ${{ steps.get-baseline.outputs.baseline-sha }}
      state-initialized: ${{ steps.get-baseline.outputs.initialized }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Get or initialize baseline
        id: get-baseline
        run: |
          echo "ðŸ” Checking for baseline.sha..."
          
          BASELINE_FILE=".state/baseline.sha"
          
          if [ -f "$BASELINE_FILE" ] && [ -s "$BASELINE_FILE" ]; then
            BASELINE_SHA=$(cat "$BASELINE_FILE" | tr -d '[:space:]')
            
            # Verify SHA exists in repo
            if git cat-file -e "$BASELINE_SHA" 2>/dev/null; then
              echo "âœ… Found valid baseline: $BASELINE_SHA"
              echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
              echo "initialized=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Baseline SHA $BASELINE_SHA not found in repo, reinitializing..."
              BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
              echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
              echo "initialized=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ“ No baseline found, initializing to repository root commit..."
            BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
            
            mkdir -p .state
            echo "$BASELINE_SHA" > "$BASELINE_FILE"
            
            echo "âœ… Initialized baseline: $BASELINE_SHA"
            echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ðŸ“Š Baseline Summary:"
          echo "   SHA: $BASELINE_SHA"
          echo "   Commit: $(git log -1 --format='%s' $BASELINE_SHA)"
          echo "   Date: $(git log -1 --format='%ci' $BASELINE_SHA)"

  # Detect changed policies
  detect-policies:
    name: Detect Changed Policies
    needs: [initialize]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      policies: ${{ steps.detect.outputs.changed-policies }}
      policies-matrix: ${{ steps.detect.outputs.changed-policies-matrix }}
      policy-count: ${{ steps.detect.outputs.policy-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/actions/policy-operations
          npm install --production

      - name: Detect changed policies
        id: detect
        uses: ./.github/actions/policy-operations
        with:
          operation: detect
          baseline-sha: ${{ needs.initialize.outputs.baseline-sha }}
          state-file: .state/delivered.json
          workspace: ${{ github.workspace }}

      - name: Summary
        run: |
          echo "## ðŸ” Policy Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Baseline SHA:** \`${{ needs.initialize.outputs.baseline-sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Policies:** ${{ steps.detect.outputs.policy-count }}" >> $GITHUB_STEP_SUMMARY

  # Process all policies efficiently in single job (no matrix duplication)
  process-policies:
    name: Process All Policies  
    needs: [detect-policies]
    if: needs.detect-policies.outputs.policy-count > 0
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      policies-processed: ${{ steps.process-summary.outputs.policies-processed }}
      policies-published: ${{ steps.process-summary.outputs.policies-published }}
      policies-failed: ${{ steps.process-summary.outputs.policies-failed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup Node.js (once for all policies)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (once for all policies)
        run: |
          cd .github/actions/policy-operations
          npm install --production

      - name: Process all policies in sequence
        env:
          POLICIES_MATRIX: ${{ needs.detect-policies.outputs.policies-matrix }}
        run: |
          echo "ðŸš€ Processing all policies efficiently in single job"
          echo "=================================================================================="
          
          # Parse the matrix JSON and process each policy
          policies=$(echo "$POLICIES_MATRIX" | jq -r '.include[] | @base64')
          
          processed_count=0
          published_count=0
          failed_count=0
          failed_policies=""
          
          for policy_b64 in $policies; do
            policy=$(echo "$policy_b64" | base64 --decode)
            policy_path=$(echo "$policy" | jq -r '.path')
            policy_name=$(echo "$policy" | jq -r '.name')
            policy_version=$(echo "$policy" | jq -r '.version')
            
            echo ""
            echo "ðŸ“¦ Processing: $policy_name $policy_version ($policy_path)"
            echo "=================================================================================="
            
            processed_count=$((processed_count + 1))
            policy_failed=false
            
            # Use GitHub Actions steps in a loop - this approach will work better
            echo "policy_path=$policy_path" >> $GITHUB_ENV
            echo "policy_name=$policy_name" >> $GITHUB_ENV  
            echo "policy_version=$policy_version" >> $GITHUB_ENV
          done
          
          # We'll handle the processing via individual action steps that get the env vars
          echo "policies_to_process=$(echo "$POLICIES_MATRIX" | jq -r '.include')" >> $GITHUB_ENV

      - name: Process each policy (using proper action calls)
        env:
          POLICIES_JSON: ${{ needs.detect-policies.outputs.policies-matrix }}
        run: |
          # This is a more complex approach - let me simplify by using a different method
          echo "ðŸ“ Preparing to process policies via action calls..."
          
          # Create a simple script that calls our action for each policy
          cat > process_policies.js << 'EOF'
          const core = require('@actions/core');
          const exec = require('@actions/exec');
          const fs = require('fs');
          const path = require('path');
          
          async function main() {
            const policiesMatrix = JSON.parse(process.env.POLICIES_JSON);
            const policies = policiesMatrix.include;
            
            let processed = 0, published = 0, failed = 0;
            const failedPolicies = [];
            
            for (const policy of policies) {
              console.log(`\nðŸ“¦ Processing: ${policy.name} ${policy.version}`);
              console.log('='.repeat(80));
              
              processed++;
              let policyFailed = false;
              
              try {
                // Step 1: Check API existence
                console.log('ðŸ” Step 1: Checking API existence...');
                const checkCmd = `node .github/actions/policy-operations/index.js`;
                const checkEnv = {
                  INPUT_OPERATION: 'check-api-existence',
                  INPUT_POLICY_PATH: policy.path,
                  INPUT_POLICY_NAME: policy.name, 
                  INPUT_POLICY_VERSION: policy.version,
                  INPUT_API_URL: process.env.POLICY_HUB_API_URL,
                  INPUT_API_KEY: process.env.POLICY_HUB_API_KEY,
                  INPUT_STATE_FILE: '.state/delivered.json',
                  INPUT_WORKSPACE: process.env.GITHUB_WORKSPACE
                };
                
                try {
                  await exec.exec('node', ['.github/actions/policy-operations/index.js'], {
                    env: { ...process.env, ...checkEnv },
                    ignoreReturnCode: true
                  });
                  // If API check indicates policy exists, continue to next
                  continue;
                } catch (e) {
                  console.log('ðŸ“ Policy does not exist in API - proceeding...');
                }
                
                // Step 2: Validate
                console.log('ðŸ” Step 2: Validating policy...');
                const validateEnv = {
                  INPUT_OPERATION: 'validate',
                  INPUT_POLICY_PATH: policy.path,
                  INPUT_CONFIG_FILE: 'config/policy-hub-config.json',
                  INPUT_WORKSPACE: process.env.GITHUB_WORKSPACE
                };
                
                await exec.exec('node', ['.github/actions/policy-operations/index.js'], {
                  env: { ...process.env, ...validateEnv }
                });
                
                console.log('âœ… Validation passed');
                
                // Step 3: Publish
                console.log('ðŸš€ Step 3: Publishing policy...');
                const publishEnv = {
                  INPUT_OPERATION: 'publish',
                  INPUT_POLICY_PATH: policy.path,
                  INPUT_POLICY_NAME: policy.name,
                  INPUT_POLICY_VERSION: policy.version,
                  INPUT_API_URL: process.env.POLICY_HUB_API_URL,
                  INPUT_API_KEY: process.env.POLICY_HUB_API_KEY,
                  INPUT_WORKSPACE: process.env.GITHUB_WORKSPACE
                };
                
                await exec.exec('node', ['.github/actions/policy-operations/index.js'], {
                  env: { ...process.env, ...publishEnv }
                });
                
                console.log(`âœ… Successfully published ${policy.name} ${policy.version}`);
                published++;
                
                // Step 4: Update state
                const updateEnv = {
                  INPUT_OPERATION: 'update-state',
                  INPUT_POLICY_PATH: policy.path,
                  INPUT_RELEASE_TAG: process.env.RELEASE_TAG,
                  INPUT_STATE_FILE: '.state/delivered.json',
                  INPUT_WORKSPACE: process.env.GITHUB_WORKSPACE
                };
                
                await exec.exec('node', ['.github/actions/policy-operations/index.js'], {
                  env: { ...process.env, ...updateEnv },
                  ignoreReturnCode: true
                });
                
              } catch (error) {
                console.error(`âŒ Failed to process ${policy.name} ${policy.version}: ${error.message}`);
                failed++;
                failedPolicies.push(`${policy.name}:${policy.version}`);
                policyFailed = true;
              }
            }
            
            // Set outputs
            core.setOutput('processed', processed.toString());
            core.setOutput('published', published.toString());
            core.setOutput('failed', failed.toString());
            
            console.log('\nðŸ“Š Processing Summary:');
            console.log(`   Processed: ${processed}`);
            console.log(`   Published: ${published}`);
            console.log(`   Failed: ${failed}`);
            if (failedPolicies.length > 0) {
              console.log(`   Failed policies: ${failedPolicies.join(', ')}`);
            }
          }
          
          main().catch(error => {
            console.error('Processing failed:', error);
            process.exit(1);
          });
          EOF
          
          # Install required dependencies for our script
          cd .github/actions/policy-operations && npm install @actions/exec
          cd ../../..
          
          # Run the processing script
          RELEASE_TAG="${{ github.event.release.tag_name }}" node process_policies.js

      - name: Upload delivery state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: delivery-state-final
          path: .state/delivered.json
          retention-days: 1

  # Merge delivery states and commit to repository
  finalize-state:
    name: Finalize & Commit State
    needs: [process-policies]
    if: always() && needs.process-policies.result != 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download delivery state artifact
        uses: actions/download-artifact@v4
        with:
          name: delivery-state-final
          path: ./state-artifacts

      - name: Copy final delivery state  
        run: |
          echo "ðŸ”„ Using final delivery state..."
          mkdir -p .state
          
          # Copy the final state from our single processing job
          if [ -f ./state-artifacts/delivered.json ]; then
            cp ./state-artifacts/delivered.json .state/delivered.json
            echo "âœ… Final delivery state copied"
            
            # Show summary
            policy_count=$(jq '. | length' .state/delivered.json)
            echo "ðŸ“Š Final state contains $policy_count delivered policies"
          else
            echo "âš ï¸ No delivery state found, creating empty state"
            echo '{}' > .state/delivered.json
          fi

      - name: Commit state changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Always add delivery state changes
          git add .state/delivered.json
          
          # Only advance baseline if ALL policies were successfully published
          if [ "${{ needs.publish-policies.result }}" == "success" ]; then
            echo "âœ… All policies published successfully - advancing baseline"
            echo "${{ github.sha }}" > .state/baseline.sha
            git add .state/baseline.sha
            COMMIT_MSG="chore: update delivery state and advance baseline after successful release ${{ github.event.release.tag_name }}"
          else
            echo "âš ï¸  Some policies failed - keeping current baseline for retry"
            COMMIT_MSG="chore: update delivery state after partial release ${{ github.event.release.tag_name }} (failed policies will retry)"
          fi
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No state changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:${{ github.event.release.target_commitish }}
            echo "âœ… Committed state changes"
          fi

  # Summary report
  summary:
    name: Release Summary
    needs: [initialize, detect-policies, process-policies, finalize-state]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Release Summary: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Baseline SHA | \`${{ needs.initialize.outputs.baseline-sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Detected | ${{ needs.detect-policies.outputs.policy-count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Processed | ${{ needs.process-policies.outputs.policies-processed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Published | ${{ needs.process-policies.outputs.policies-published || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Failed | ${{ needs.process-policies.outputs.policies-failed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Processing Status | ${{ needs.process-policies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| State Finalized | ${{ needs.finalize-state.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.process-policies.result }}" == "success" ]; then
            echo "## âœ… Release Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All policies were successfully published and state has been updated." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.process-policies.result }}" == "failure" ]; then
            echo "## âš ï¸ Partial Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some policies failed to publish. Failed policies will be automatically retried on the next release." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
