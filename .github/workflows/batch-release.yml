name: Batch Release

on:
  release:
    types: [published]

env:
  S3_BUCKET: ${{ vars.S3_BUCKET_NAME }}
  POLICY_HUB_API_URL: ${{ vars.POLICY_HUB_API_URL }}
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  detect-versions:
    runs-on: ubuntu-latest
    outputs:
      new-versions: ${{ steps.detect.outputs.new-versions }}
      new-versions-json: ${{ steps.format.outputs.json }}
      version-count: ${{ steps.count.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Get base SHA
        id: get_base
        run: |
          current_tag="${{ github.event.release.tag_name }}"
          
          echo "Current release tag: $current_tag"
          
          # Get all tags except the current one, sorted by version
          all_tags=$(git tag --list --sort=-version:refname)
          echo "All tags: $all_tags"
          
          # Filter out current tag to get previous tags
          previous_tags=$(echo "$all_tags" | grep -v "^${current_tag}$" | head -5)
          echo "Previous tags (excluding current): $previous_tags"
          
          # Get the most recent previous tag
          last_tag=$(echo "$previous_tags" | head -1)
          
          if [ -z "$last_tag" ]; then
            # No previous tags found - this is the first release
            base_sha=$(git rev-list --max-parents=0 HEAD)
            echo "‚úÖ First release detected, using initial commit: $base_sha"
          else
            # Use previous tag for subsequent releases
            base_sha="$last_tag"
            echo "‚úÖ Using previous release tag: $base_sha"
          fi
          
          echo "base_sha=$base_sha" >> $GITHUB_OUTPUT
        shell: bash

      - name: Detect new policy versions
        id: detect
        uses: ./.github/actions/detect-versions
        with:
          base-sha: ${{ steps.get_base.outputs.base_sha }}
          head-sha: ${{ github.sha }}

      - name: Format versions for matrix
        id: format
        run: |
          versions="${{ steps.detect.outputs.new-versions }}"
          json_array="[]"
          if [ -n "$versions" ]; then
            json_array="["
            first=true
            for version_path in $versions; do
              if [ "$first" = true ]; then
                first=false
              else
                json_array+=","
              fi
              policy=$(echo $version_path | cut -d'/' -f1)
              version=$(echo $version_path | cut -d'/' -f2)
              json_array+="{\"policy\":\"$policy\",\"version\":\"$version\"}"
            done
            json_array+="]"
          fi
          echo "json=$json_array" >> $GITHUB_OUTPUT

      - name: Count versions
        id: count
        run: |
          version_count=$(echo "${{ steps.detect.outputs.new-versions }}" | wc -w)
          echo "count=$version_count" >> $GITHUB_OUTPUT

  validate-policies:
    needs: detect-versions
    if: needs.detect-versions.outputs.version-count > 0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate policies before release
        run: |
          echo "üîç Validating all policies before release using configurable requirements..."
          
          # Make validation script executable
          chmod +x scripts/validate-policy.sh
          
          validation_errors=0
          versions="${{ needs.detect-versions.outputs.new-versions }}"
          
          for version_path in $versions; do
            policy=$(echo $version_path | cut -d'/' -f1)
            version=$(echo $version_path | cut -d'/' -f2)
            
            echo "üìã Pre-release validation for $policy/$version"
            
            if ./scripts/validate-policy.sh "$policy" "$version" 2>&1; then
              echo "‚úÖ Pre-release validation passed for $policy/$version"
            else
              echo "‚ùå Pre-release validation failed for $policy/$version"
              ((validation_errors++))
            fi
          done
          
          if [ $validation_errors -gt 0 ]; then
            echo ""
            echo "üí• Pre-release validation failed with $validation_errors error(s)."
            echo "üìã Release blocked - fix validation issues before publishing"
            exit 1
          else
            echo ""
            echo "üéâ All policies passed pre-release validation!"
            echo "üìã Ready for publishing with configurable requirements verified"
          fi

  publish-policies:
    needs: [detect-versions, validate-policies]
    if: needs.detect-versions.outputs.version-count > 0
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        version-item: ${{ fromJSON(needs.detect-versions.outputs.new-versions-json) }}
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Publish policy version
        id: publish
        uses: ./.github/actions/publish-policy
        with:
          policy: ${{ matrix.version-item.policy }}
          version: ${{ matrix.version-item.version }}
          s3-bucket: ${{ vars.S3_BUCKET_NAME }}
          policy-hub-url: ${{ vars.POLICY_HUB_API_URL }}
          repo-url: ${{ github.server_url }}/${{ github.repository }}
          policy-hub-api-key: ${{ secrets.POLICY_HUB_API_KEY }}

      - name: Report result
        if: always()
        run: |
          if [[ "${{ steps.publish.outputs.success }}" == "true" ]]; then
            echo "‚úÖ Successfully published ${{ matrix.version-item.policy }} ${{ matrix.version-item.version }}"
          else
            echo "‚ùå Failed to publish ${{ matrix.version-item.policy }} ${{ matrix.version-item.version }}"
            exit 1
          fi