name: Batch Release - Reliable Policy Delivery

on:
  release:
    types: [published]

concurrency:
  group: release-${{ github.event.release.tag_name }}
  cancel-in-progress: false

env:
  POLICY_HUB_API_URL: ${{ vars.POLICY_HUB_API_URL }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  MAX_PARALLEL: ${{ vars.MAX_PARALLEL || 3 }}

jobs:
  # Initialize baseline and state
  initialize:
    name: Initialize Baseline & State
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      baseline-sha: ${{ steps.get-baseline.outputs.baseline-sha }}
      state-initialized: ${{ steps.get-baseline.outputs.initialized }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Get or initialize baseline
        id: get-baseline
        run: |
          echo "ðŸ” Checking for baseline.sha..."
          
          BASELINE_FILE=".state/baseline.sha"
          
          if [ -f "$BASELINE_FILE" ] && [ -s "$BASELINE_FILE" ]; then
            BASELINE_SHA=$(cat "$BASELINE_FILE" | tr -d '[:space:]')
            
            # Verify SHA exists in repo
            if git cat-file -e "$BASELINE_SHA" 2>/dev/null; then
              echo "âœ… Found valid baseline: $BASELINE_SHA"
              echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
              echo "initialized=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Baseline SHA $BASELINE_SHA not found in repo, reinitializing..."
              BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
              echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
              echo "initialized=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ“ No baseline found, initializing to repository root commit..."
            BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
            
            mkdir -p .state
            echo "$BASELINE_SHA" > "$BASELINE_FILE"
            
            echo "âœ… Initialized baseline: $BASELINE_SHA"
            echo "baseline-sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
            echo "initialized=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ðŸ“Š Baseline Summary:"
          echo "   SHA: $BASELINE_SHA"
          echo "   Commit: $(git log -1 --format='%s' $BASELINE_SHA)"
          echo "   Date: $(git log -1 --format='%ci' $BASELINE_SHA)"

  # Detect changed policies
  detect-policies:
    name: Detect Changed Policies
    needs: [initialize]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      policies: ${{ steps.detect.outputs.changed-policies }}
      policies-matrix: ${{ steps.detect.outputs.changed-policies-matrix }}
      policy-count: ${{ steps.detect.outputs.policy-count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/actions/policy-operations
          npm install --production

      - name: Detect changed policies
        id: detect
        uses: ./.github/actions/policy-operations
        with:
          operation: detect
          baseline-sha: ${{ needs.initialize.outputs.baseline-sha }}
          state-file: .state/delivered.json
          workspace: ${{ github.workspace }}

      - name: Summary
        run: |
          echo "## ðŸ” Policy Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Baseline SHA:** \`${{ needs.initialize.outputs.baseline-sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Policies:** ${{ steps.detect.outputs.policy-count }}" >> $GITHUB_STEP_SUMMARY

  # Check API existence, validate and check delivery status (parallel per policy)
  validate-and-check:
    name: Validate & Check - ${{ matrix.name }} ${{ matrix.version }}
    needs: [detect-policies]
    if: needs.detect-policies.outputs.policy-count > 0
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJson(vars.MAX_PARALLEL || '3') }}
      matrix: ${{ fromJson(needs.detect-policies.outputs.policies-matrix) }}
    outputs:
      should-deliver-${{ matrix.path }}: ${{ steps.final-decision.outputs.should-deliver }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/actions/policy-operations
          npm install --production

      - name: Check if policy exists in API
        id: api-check
        uses: ./.github/actions/policy-operations
        with:
          operation: check-api-existence
          policy-path: ${{ matrix.path }}
          policy-name: ${{ matrix.name }}
          policy-version: ${{ matrix.version }}
          api-url: ${{ env.POLICY_HUB_API_URL }}
          api-key: ${{ secrets.POLICY_HUB_API_KEY }}
          state-file: .state/delivered.json
          workspace: ${{ github.workspace }}

      - name: Upload updated state (if policy exists in API)
        if: steps.api-check.outputs.should-skip == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-state-${{ matrix.name }}-${{ matrix.version }}
          path: .state/delivered.json
          retention-days: 1

      - name: Validate policy structure
        id: validate
        if: steps.api-check.outputs.should-skip == 'false'
        uses: ./.github/actions/policy-operations
        with:
          operation: validate
          policy-path: ${{ matrix.path }}
          config-file: config/policy-hub-config.json
          workspace: ${{ github.workspace }}

      - name: Final decision
        id: final-decision
        if: always()
        run: |
          if [ "${{ steps.api-check.outputs.should-skip }}" == "true" ]; then
            echo "should-deliver=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Policy exists in API - skipped validation and marked as delivered"
          elif [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "should-deliver=true" >> $GITHUB_OUTPUT
            echo "âœ… Policy validation passed - ready for delivery"
          else
            echo "should-deliver=false" >> $GITHUB_OUTPUT
            echo "âŒ Policy validation failed - will not deliver"
          fi
          
          echo "Policy: ${{ matrix.path }}"
          echo "API Check: ${{ steps.api-check.outputs.check-result }}"
          echo "Validation: ${{ steps.validate.outcome }}"
          echo "Should Deliver: ${{ steps.final-decision.outputs.should-deliver }}"

  # Publish policies (parallel per policy that needs delivery)
  publish-policies:
    name: Publish - ${{ matrix.name }} ${{ matrix.version }}
    needs: [detect-policies, validate-and-check]
    if: needs.detect-policies.outputs.policy-count > 0
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJson(vars.MAX_PARALLEL || '3') }}
      matrix: ${{ fromJson(needs.detect-policies.outputs.policies-matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/actions/policy-operations
          npm install --production

      - name: Check if should deliver
        id: should-deliver
        run: |
          # This step will be skipped if the policy doesn't need delivery
          SHOULD_DELIVER="${{ needs.validate-and-check.outputs[format('should-deliver-{0}', matrix.path)] }}"
          echo "Should deliver this policy: $SHOULD_DELIVER"
          echo "should-deliver=$SHOULD_DELIVER" >> $GITHUB_OUTPUT
          
          if [ "$SHOULD_DELIVER" != "true" ]; then
            echo "â­ï¸ Skipping policy - no delivery needed"
            exit 0
          fi

      - name: Publish to Policy Hub
        id: publish
        if: steps.should-deliver.outputs.should-deliver == 'true'
        uses: ./.github/actions/policy-operations
        with:
          operation: publish
          policy-path: ${{ matrix.path }}
          policy-name: ${{ matrix.name }}
          policy-version: ${{ matrix.version }}
          api-url: ${{ env.POLICY_HUB_API_URL }}
          api-key: ${{ secrets.POLICY_HUB_API_KEY }}
          workspace: ${{ github.workspace }}

      - name: Update delivery state
        if: steps.should-deliver.outputs.should-deliver == 'true' && success()
        uses: ./.github/actions/policy-operations
        with:
          operation: update-state
          policy-path: ${{ matrix.path }}
          release-tag: ${{ github.event.release.tag_name }}
          state-file: .state/delivered.json
          workspace: ${{ github.workspace }}

      - name: Upload state file
        if: steps.should-deliver.outputs.should-deliver == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: delivery-state-${{ matrix.name }}-${{ matrix.version }}
          path: .state/delivered.json
          retention-days: 1

  # Merge delivery states and commit to repository
  finalize-state:
    name: Finalize & Commit State
    needs: [publish-policies]
    if: always() && needs.publish-policies.result != 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all state artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: delivery-state-*
          path: ./state-artifacts

      - name: Merge delivery states
        run: |
          echo "ðŸ”„ Merging delivery states..."
          
          # Start with current state or empty object
          if [ -f .state/delivered.json ]; then
            cp .state/delivered.json merged-state.json
          else
            echo '{}' > merged-state.json
          fi
          
          # Merge all artifact states using Node.js
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          let mergedState = JSON.parse(fs.readFileSync('merged-state.json', 'utf8'));
          
          // Read all state files from artifacts
          const artifactsDir = './state-artifacts';
          
          if (fs.existsSync(artifactsDir)) {
            const artifacts = fs.readdirSync(artifactsDir);
            
            for (const artifact of artifacts) {
              const stateFile = path.join(artifactsDir, artifact, 'delivered.json');
              
              if (fs.existsSync(stateFile)) {
                const state = JSON.parse(fs.readFileSync(stateFile, 'utf8'));
                
                // Merge states (newer entries win)
                Object.assign(mergedState, state);
                
                console.log(`âœ… Merged state from ${artifact}`);
              }
            }
          }
          
          // Write merged state
          fs.writeFileSync('.state/delivered.json', JSON.stringify(mergedState, null, 2));
          
          console.log(`\nðŸ“Š Final state contains ${Object.keys(mergedState).length} policies`);
          EOF
          
          echo ""
          echo "âœ… State merge complete"

      - name: Commit state changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Always add delivery state changes
          git add .state/delivered.json
          
          # Only advance baseline if ALL policies were successfully published
          if [ "${{ needs.publish-policies.result }}" == "success" ]; then
            echo "âœ… All policies published successfully - advancing baseline"
            echo "${{ github.sha }}" > .state/baseline.sha
            git add .state/baseline.sha
            COMMIT_MSG="chore: update delivery state and advance baseline after successful release ${{ github.event.release.tag_name }}"
          else
            echo "âš ï¸  Some policies failed - keeping current baseline for retry"
            COMMIT_MSG="chore: update delivery state after partial release ${{ github.event.release.tag_name }} (failed policies will retry)"
          fi
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No state changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:${{ github.event.release.target_commitish }}
            echo "âœ… Committed state changes"
          fi

  # Summary report
  summary:
    name: Release Summary
    needs: [initialize, detect-policies, validate-and-check, publish-policies, finalize-state]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Release Summary: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Baseline SHA | \`${{ needs.initialize.outputs.baseline-sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Detected | ${{ needs.detect-policies.outputs.policy-count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Status | ${{ needs.validate-and-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publishing Status | ${{ needs.publish-policies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| State Finalized | ${{ needs.finalize-state.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish-policies.result }}" == "success" ]; then
            echo "## âœ… Release Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All policies were successfully published and state has been updated." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-policies.result }}" == "failure" ]; then
            echo "## âš ï¸ Partial Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some policies failed to publish. Failed policies will be automatically retried on the next release." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
