name: Test Scripts

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - '.github/workflows/test-scripts.yml'
  pull_request:
    paths:
      - 'scripts/**'
      - '.github/workflows/test-scripts.yml'

jobs:
  test-prepare-zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test policy structure
        run: |
          mkdir -p test/policies/test-policy/v1.0.0/src
          mkdir -p test/policies/test-policy/v1.0.0/docs
          
          # Create Go source file
          cat > test/policies/test-policy/v1.0.0/src/main.go << 'EOF'
          package main

          import "fmt"

          func main() {
              fmt.Println("Hello, Policy!")
          }
          EOF
          
          # Create metadata.json
          cat > test/policies/test-policy/v1.0.0/metadata.json << 'EOF'
          {
            "name": "test-policy",
            "displayName": "Test Policy",
            "provider": "test-provider",
            "categories": ["security", "compliance"],
            "description": "Test policy for validation",
            "version": "v1.0.0"
          }
          EOF
          
          # Create policy-definition.yaml
          cat > test/policies/test-policy/v1.0.0/policy-definition.yaml << 'EOF'
          apiVersion: policy/v1
          kind: Policy
          metadata:
            name: test-policy
          spec:
            rules:
              - name: test-rule
                condition: "true"
                action: allow
          EOF
          
          # Create documentation files
          cat > test/policies/test-policy/v1.0.0/docs/overview.md << 'EOF'
          # Test Policy Overview

          This is a test policy for validation purposes.

          ## Purpose

          Demonstrates policy structure validation.
          EOF
          
          cat > test/policies/test-policy/v1.0.0/docs/configuration.md << 'EOF'
          # Configuration

          ## Parameters

          - `enabled`: Enable or disable the policy (default: true)
          EOF
          
          cat > test/policies/test-policy/v1.0.0/docs/examples.md << 'EOF'
          # Examples

          ## Basic Usage

          ```yaml
          apiVersion: policy/v1
          kind: Policy
          metadata:
            name: test-policy
          spec:
            rules:
              - name: test-rule
                condition: "true"
                action: allow
          ```
          EOF

      - name: Test prepare-zip.sh with valid input
        run: |
          # Copy test policy to expected location for script
          mkdir -p policies/test-policy/v1.0.0
          cp -r test/policies/test-policy/v1.0.0/* policies/test-policy/v1.0.0/
          
          if ./scripts/prepare-zip.sh test-policy v1.0.0; then
            echo "✅ prepare-zip.sh succeeded"
            if [ -f "test-policy-v1.0.0.zip" ]; then
              echo "✅ ZIP file created"
              # Verify ZIP contents
              unzip -l test-policy-v1.0.0.zip | grep -q "src/main.go"
              if [ $? -eq 0 ]; then
                echo "✅ ZIP contains expected source files"
              else
                echo "❌ ZIP missing expected source files"
                exit 1
              fi
              unzip -l test-policy-v1.0.0.zip | grep -q "docs/overview.md"
              if [ $? -eq 0 ]; then
                echo "✅ ZIP contains expected docs files"
              else
                echo "❌ ZIP missing expected docs files"
                exit 1
              fi
              # Cleanup
              rm -rf policies/test-policy
              rm -f test-policy-v1.0.0.zip
            else
              echo "❌ ZIP file not created"
              exit 1
            fi
          else
            echo "❌ prepare-zip.sh failed"
            exit 1
          fi

      - name: Test prepare-zip.sh with invalid policy name
        run: |
          if ./scripts/prepare-zip.sh "test policy" v1.0.0 2>/dev/null; then
            echo "❌ prepare-zip.sh should have failed with invalid policy name"
            exit 1
          else
            echo "✅ prepare-zip.sh correctly rejected invalid policy name"
          fi

      - name: Test prepare-zip.sh with invalid version
        run: |
          if ./scripts/prepare-zip.sh test-policy "1.0.0" 2>/dev/null; then
            echo "❌ prepare-zip.sh should have failed with invalid version"
            exit 1
          else
            echo "✅ prepare-zip.sh correctly rejected invalid version"
          fi

      - name: Test prepare-zip.sh with missing source directory
        run: |
          if ./scripts/prepare-zip.sh nonexistent-policy v1.0.0 2>/dev/null; then
            echo "❌ prepare-zip.sh should have failed with missing directory"
            exit 1
          else
            echo "✅ prepare-zip.sh correctly failed with missing directory"
          fi

      - name: Cleanup
        run: rm -rf test

  test-validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test validate-config.sh with valid config
        run: |
          if ./scripts/validate-config.sh; then
            echo "✅ validate-config.sh succeeded with valid config"
          else
            echo "❌ validate-config.sh failed with valid config"
            exit 1
          fi

      - name: Test validate-config.sh with invalid JSON
        run: |
          echo '{"invalid": json' > config/test-config.json
          mv config/policy-hub-config.json config/policy-hub-config.json.backup
          mv config/test-config.json config/policy-hub-config.json
          if ./scripts/validate-config.sh 2>/dev/null; then
            echo "❌ validate-config.sh should have failed with invalid JSON"
            exit 1
          else
            echo "✅ validate-config.sh correctly rejected invalid JSON"
          fi

      - name: Restore config after invalid JSON test
        if: always()
        run: |
          if [ -f "config/policy-hub-config.json.backup" ]; then
            mv config/policy-hub-config.json.backup config/policy-hub-config.json
          fi

      - name: Test validate-config.sh with missing required field
        run: |
          jq 'del(.processing.maxParallelJobs)' config/policy-hub-config.json > config/test-config.json
          mv config/policy-hub-config.json config/policy-hub-config.json.backup
          mv config/test-config.json config/policy-hub-config.json
          if ./scripts/validate-config.sh 2>/dev/null; then
            echo "❌ validate-config.sh should have failed with missing field"
            exit 1
          else
            echo "✅ validate-config.sh correctly rejected config with missing field"
          fi

      - name: Restore config after missing field test
        if: always()
        run: |
          if [ -f "config/policy-hub-config.json.backup" ]; then
            mv config/policy-hub-config.json.backup config/policy-hub-config.json
          fi