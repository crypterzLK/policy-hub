name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'policies/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate policy structure (Configurable)
        id: validate
        run: |
          echo "üîç Validating policy structure using configurable requirements..."

          # Check for policies folder
          if [ ! -d "policies" ]; then
            echo "‚ùå Error: policies/ directory not found"
            exit 1
          fi

          # Make validation script executable
          chmod +x scripts/validate-policy.sh

          validation_errors=0

          # Find all policy versions and validate using configurable validation
          while IFS= read -r -d '' policy_dir; do
            policy_name=$(basename "$policy_dir")

            # Find version directories
            while IFS= read -r -d '' version_dir; do
              version=$(basename "$version_dir")

              echo "üìã Validating $policy_name/$version with configurable requirements"
              
              # Use configurable validation script
              if ./scripts/validate-policy.sh "$policy_name" "$version" 2>&1; then
                echo "‚úÖ Policy validation passed for $policy_name/$version"
              else
                echo "‚ùå Policy validation failed for $policy_name/$version"
                ((validation_errors++))
              fi

              # Additional custom validation logic can be added here if needed
              # Standard validation is handled by the configurable validation script

            done < <(find "$policy_dir" -mindepth 1 -maxdepth 1 -type d -print0)

          done < <(find policies -mindepth 1 -maxdepth 1 -type d -print0)

          if [ $validation_errors -gt 0 ]; then
            echo ""
            echo "üí• Found $validation_errors validation error(s). Please fix them before merging."
            echo "üìã Validation performed using configurable requirements from config/policy-hub-config.json"
            exit 1
          else
            echo ""
            echo "üéâ All policy validations passed using configurable requirements!"
            echo "üìã Configuration: $(jq -r '.validation | keys | join(", ")' config/policy-hub-config.json)"
          fi

      - name: Detect new policy versions in PR
        id: detect
        uses: ./.github/actions/detect-versions
        with:
          base-sha: ${{ github.event.pull_request.base.sha }}
          head-sha: ${{ github.event.pull_request.head.sha }}

      - name: Comment on PR with validation results
        if: always()
        run: |
          # Determine overall status
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            status="‚úÖ **Validation Passed**"
          else
            status="‚ùå **Validation Failed**"
          fi

          comment="## Policy Validation Results

$status

"

          # Add new versions section if any detected
          if [ -n "${{ steps.detect.outputs.new_versions }}" ]; then
            comment+="### New Policy Versions Detected:
"
            for version_path in ${{ steps.detect.outputs.new_versions }}; do
              policy=$(echo "$version_path" | cut -d'/' -f1)
              version=$(echo "$version_path" | cut -d'/' -f2)
              comment+=" - **$policy** $version
"
            done
            comment+="
These versions will be published in the next batch release."
          else
            comment+="### No New Policy Versions
This PR does not add new policy versions."
          fi

          # Add configurable validation information
          comment+="
### Configurable Policy Validation

‚ú® **Policy validation now uses configurable requirements** from \`config/policy-hub-config.json\`

#### Current Configuration:
"
          # Add current configuration details
          if [ -f "config/policy-hub-config.json" ]; then
            comment+="- **Required Files:** $(jq -r '.validation.requiredFiles | join(", ")' config/policy-hub-config.json)
- **Required Directories:** $(jq -r '.validation.requiredDirs | join(", ")' config/policy-hub-config.json)  
- **Required Docs:** $(jq -r '.validation.requiredDocsFiles | join(", ")' config/policy-hub-config.json)
- **Required Metadata Fields:** $(jq -r '.validation.requiredMetadataFields | join(", ")' config/policy-hub-config.json)
- **Strict Validation:** $(jq -r '.validation.strictValidation' config/policy-hub-config.json)

üí° **Tip:** Use \`./scripts/manage-config.sh list\` to view all configurable requirements
üîß **Customize:** Modify validation requirements in \`config/policy-hub-config.json\`"
          else
            comment+="‚ö†Ô∏è  Configuration file not found - using default validation rules"
          fi

          comment+="

#### Standard Requirements:"

All requirements are now configurable through \`config/policy-hub-config.json\`

### Validation Tools
- **Validate locally:** \`./scripts/validate-policy.sh <policy-name> <version>\`
- **View configuration:** \`./scripts/manage-config.sh list\`
- **Modify requirements:** \`./scripts/manage-config.sh set <key> <value>\`

### Next Steps
1. Fix any validation errors shown above
2. Use configurable validation tools to verify compliance
3. Ensure all requirements from current configuration are met
4. Ensure PR is reviewed and approved
5. Merge PR to main branch
6. Create GitHub release to trigger batch publishing with pre-release validation"

          gh pr comment ${{ github.event.pull_request.number }} --body "$comment" || echo "Failed to post comment"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}