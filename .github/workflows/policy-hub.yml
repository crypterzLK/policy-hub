name: Policy Hub Validation and Publishing

on:
  pull_request:
    branches: [main]
    paths:
      - "policies/**"
  release:
    types: [published]

env:
  POLICY_HUB_API_URL: ${{ vars.POLICY_HUB_API_URL }}
  POLICY_HUB_API_KEY: ${{ secrets.POLICY_HUB_API_KEY }}
  POLICY_HUB_AUTH_HEADER: ${{ vars.POLICY_HUB_AUTH_HEADER }}
  POLICY_HUB_AUTH_VALUE: ${{ vars.POLICY_HUB_AUTH_VALUE }}

jobs:
  initialize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      baseline: ${{ steps.baseline.outputs.sha }}
      is_release: ${{ steps.check_trigger.outputs.is_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate environment
        run: |
          if [ -z "${{ env.POLICY_HUB_API_URL }}" ]; then
            echo "❌ POLICY_HUB_API_URL is not set"
            exit 1
          fi
          if [ -z "${{ env.POLICY_HUB_API_KEY }}" ]; then
            echo "❌ POLICY_HUB_API_KEY is not set"
            exit 1
          fi
          # Set defaults for auth header if not provided
          if [ -z "${{ env.POLICY_HUB_AUTH_HEADER }}" ]; then
            echo "POLICY_HUB_AUTH_HEADER=Authorization" >> $GITHUB_ENV
          fi
          if [ -z "${{ env.POLICY_HUB_AUTH_VALUE }}" ]; then
            echo "POLICY_HUB_AUTH_VALUE=Bearer ${{ env.POLICY_HUB_API_KEY }}" >> $GITHUB_ENV
          fi
          echo "✅ Environment variables validated"

      - name: Validate tools
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            echo "❌ jq is not installed"
            exit 1
          fi
          if ! command -v git >/dev/null 2>&1; then
            echo "❌ git is not available"
            exit 1
          fi
          if ! command -v zip >/dev/null 2>&1; then
            echo "❌ zip is not available"
            exit 1
          fi
          echo "✅ Required tools available"

      - name: Read or initialize baseline
        id: baseline
        run: |
          if [ -f .state/baseline.sha ]; then
            BASELINE_SHA=$(grep -E '^[0-9a-f]{40}$' .state/baseline.sha | head -1)
            if [ -n "$BASELINE_SHA" ]; then
              echo "sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
            else
              # Invalid baseline, reinitialize
              BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
              echo "sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
              mkdir -p .state
              echo "$BASELINE_SHA" > .state/baseline.sha
            fi
          else
            # Initialize with the initial commit
            BASELINE_SHA=$(git rev-list --max-parents=0 HEAD)
            echo "sha=$BASELINE_SHA" >> $GITHUB_OUTPUT
            mkdir -p .state
            echo "$BASELINE_SHA" > .state/baseline.sha
          fi

      - name: Check trigger type
        id: check_trigger
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  detect-policies:
    runs-on: ubuntu-latest
    needs: initialize
    permissions:
      contents: read
    outputs:
      policies: ${{ steps.detect.outputs.policies }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed policies
        id: detect
        run: |
          BASELINE="${{ needs.initialize.outputs.baseline }}"
          POLICIES_JSON="[]"

          # Validate baseline SHA
          if ! git cat-file -e "$BASELINE" 2>/dev/null; then
            echo "❌ Invalid baseline SHA: $BASELINE"
            exit 1
          fi

          if [ "${{ needs.initialize.outputs.is_release }}" = "true" ]; then
            # For release, detect new versions since baseline
            if ! CHANGED_POLICY_DIRS=$(git diff --name-only "$BASELINE"..HEAD 2>/dev/null | grep '^policies/[^/]\+/v[^/]\+/' | sed 's|^\(policies/[^/]\+/v[^/]\+\)/.*|\1|' | sort | uniq); then
              echo "❌ Failed to get git diff for release"
              exit 1
            fi
          else
            # For PR, detect changed policies
            if ! CHANGED_POLICY_DIRS=$(git diff --name-only "${{ github.event.pull_request.base.sha }}".."${{ github.event.pull_request.head.sha }}" 2>/dev/null | grep '^policies/[^/]\+/v[^/]\+/' | sed 's|^\(policies/[^/]\+/v[^/]\+\)/.*|\1|' | sort | uniq); then
              echo "❌ Failed to get git diff for PR"
              exit 1
            fi
          fi

          POLICIES=()
          while IFS= read -r policy_dir; do
            if [[ $policy_dir =~ ^policies/([^/]+)/v([^/]+)$ ]]; then
              POLICY_NAME="${BASH_REMATCH[1]}"
              VERSION="v${BASH_REMATCH[2]}"
              POLICY_PATH="$policy_dir"

              # Validate policy name and version format
              if [[ ! "$POLICY_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
                echo "⚠️  Skipping invalid policy name: $POLICY_NAME"
                continue
              fi
              if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                echo "⚠️  Skipping invalid version: $VERSION"
                continue
              fi

              if [ "${{ needs.initialize.outputs.is_release }}" = "true" ]; then
                # Check if already delivered
                if [ -f .state/delivered.json ]; then
                  if ! jq empty .state/delivered.json 2>/dev/null; then
                    echo "❌ Invalid delivered.json format"
                    exit 1
                  fi
                  DELIVERED=$(jq -r ".\"$POLICY_NAME\".\"$VERSION\"" .state/delivered.json 2>/dev/null || echo "null")
                  if [ "$DELIVERED" != "null" ]; then
                    echo "ℹ️  Policy $POLICY_NAME $VERSION already delivered, skipping"
                    continue
                  fi
                fi
              fi
              POLICIES+=("{\"name\":\"$POLICY_NAME\",\"version\":\"$VERSION\",\"path\":\"$POLICY_PATH\"}")
            fi
          done <<< "$CHANGED_POLICY_DIRS"

          # Process unique policies
          UNIQUE_POLICIES=$(printf '%s\n' "${POLICIES[@]}" | jq -s -c . 2>/dev/null)
          if [ $? -ne 0 ]; then
            echo "❌ Failed to process policies JSON"
            exit 1
          fi
          echo "policies=$UNIQUE_POLICIES" >> $GITHUB_OUTPUT
          echo "✅ Detected ${#POLICIES[@]} policies"

  validate:
    runs-on: ubuntu-latest
    needs: [initialize, detect-policies]
    if: needs.detect-policies.outputs.policies != '[]'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        policy: ${{ fromJson(needs.detect-policies.outputs.policies) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate policy
        run: |
          if ./scripts/validate-policy.sh ${{ matrix.policy.name }} ${{ matrix.policy.version }} > validation.log 2>&1; then
            echo '{"status": "success"}' > validation-result.json
          else
            echo '{"status": "failed"}' > validation-result.json
          fi
          cat validation.log >> validation-result.json

  publish:
    runs-on: ubuntu-latest
    needs: [initialize, detect-policies, validate]
    if: needs.initialize.outputs.is_release == 'true' && needs.detect-policies.outputs.policies != '[]'
    permissions:
      contents: write
      id-token: write
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        policy: ${{ fromJson(needs.detect-policies.outputs.policies) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare ZIP
        run: |
          if ! ./scripts/prepare-zip.sh ${{ matrix.policy.name }} ${{ matrix.policy.version }}; then
            echo "❌ Failed to prepare ZIP for ${{ matrix.policy.name }} ${{ matrix.policy.version }}"
            exit 1
          fi

          ZIP_FILE="${{ matrix.policy.name }}-${{ matrix.policy.version }}.zip"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "❌ ZIP file was not created: $ZIP_FILE"
            exit 1
          fi
          echo "✅ ZIP prepared successfully"

      - name: Publish policy
        run: |
          ZIP_FILE="${{ matrix.policy.name }}-${{ matrix.policy.version }}.zip"
          METADATA_FILE="${{ matrix.policy.path }}/metadata.json"

          # Construct multipart payload with timeout
          if ! RESPONSE=$(curl -s -w "%{http_code}" --max-time 300 -X POST "${{ env.POLICY_HUB_API_URL }}" \
            -H "${{ env.POLICY_HUB_AUTH_HEADER }}: ${{ env.POLICY_HUB_AUTH_VALUE }}" \
            -H "Idempotency-Key: ${{ github.sha }}" \
            -F "policyName=${{ matrix.policy.name }}" \
            -F "version=${{ matrix.policy.version }}" \
            -F "definitionUrl=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/${{ matrix.policy.path }}/policy-definition.yaml" \
            -F "metadata=@$METADATA_FILE" \
            -F "documentation=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/${{ matrix.policy.path }}/docs/" \
            -F "assetsBaseUrl=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/${{ matrix.policy.path }}/assets/" \
            -F "file=@$ZIP_FILE" 2>/dev/null); then
            echo "❌ curl command failed"
            exit 1
          fi

          HTTP_CODE=${RESPONSE: -3}
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "✅ Publish successful (code: $HTTP_CODE)"
            echo "SUCCESS" > publish-status.txt
          elif [ "$HTTP_CODE" = "409" ]; then
            echo "ℹ️  Policy already exists (code: $HTTP_CODE), treating as success"
            echo "SUCCESS" > publish-status.txt
          else
            echo "❌ Publish failed (code: $HTTP_CODE)"
            echo "Response: ${RESPONSE%???}"
            echo "FAILED" > publish-status.txt
            exit 1
          fi

      - name: Record delivery
        if: success()
        run: |
          mkdir -p .state
          if [ ! -f .state/delivered.json ]; then
            echo "{}" > .state/delivered.json
          fi
          jq ".\"${{ matrix.policy.name }}\".\"${{ matrix.policy.version }}\" = {\"releasedAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"releaseSha\": \"${{ github.sha }}\"}" .state/delivered.json > .state/delivered.json.tmp
          mv .state/delivered.json.tmp .state/delivered.json

      - name: Upload delivered state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: delivered-state-${{ matrix.policy.name }}-${{ matrix.policy.version }}
          path: .state/delivered.json

  finalize-state:
    runs-on: ubuntu-latest
    needs: [initialize, publish]
    if: needs.initialize.outputs.is_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all delivered states
        uses: actions/download-artifact@v4
        with:
          name: delivered-state-*
          path: .state/
        continue-on-error: true

      - name: Merge delivered states
        run: |
          # Check if any delivered state files exist
          if ! ls .state/delivered-*.json >/dev/null 2>&1; then
            echo "ℹ️  No delivered state artifacts found, initializing empty state"
            echo "{}" > .state/delivered.json
          else
            # Merge all delivered.json files
            if ! jq -s 'reduce .[] as $item ({}; . * $item)' .state/delivered-*.json > .state/delivered.json.tmp 2>/dev/null; then
              echo "❌ Failed to merge delivered states"
              exit 1
            fi
            mv .state/delivered.json.tmp .state/delivered.json

            # Validate merged JSON
            if ! jq empty .state/delivered.json 2>/dev/null; then
              echo "❌ Invalid merged delivered.json"
              exit 1
            fi
          fi
          echo "✅ Delivered states merged successfully"

      - name: Advance baseline
        if: success()
        run: |
          echo "${{ github.sha }}" > .state/baseline.sha
          echo "✅ Baseline advanced to ${{ github.sha }}"

      - name: Commit state changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .state/
          if git diff --staged --quiet; then
            echo "ℹ️  No changes to commit"
          else
            if git commit -m "Update policy hub state [${{ github.sha }}]"; then
              echo "✅ State changes committed"
            else
              echo "❌ Failed to commit state changes"
              exit 1
            fi
          fi

      - name: Push changes
        run: |
          if git push origin main; then
            echo "✅ Changes pushed to main successfully"
          else
            echo "❌ Failed to push changes to main"
            exit 1
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [initialize, detect-policies, validate, publish, finalize-state]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Policy Hub Workflow Summary" >> summary.md
          echo "" >> summary.md
          if [ "${{ needs.initialize.outputs.is_release }}" = "true" ]; then
            echo "### Release Publishing" >> summary.md
          else
            echo "### Pull Request Validation" >> summary.md
          fi
          echo "" >> summary.md
          echo "| Policy | Version | Status |" >> summary.md
          echo "|--------|---------|--------|" >> summary.md

          POLICIES='${{ needs.detect-policies.outputs.policies }}'
          if [ "$POLICIES" = "[]" ] || [ -z "$POLICIES" ]; then
            echo "| No policies | detected | ⚠️  |" >> summary.md
          else
            # Validate JSON
            if ! echo "$POLICIES" | jq empty 2>/dev/null; then
              echo "| Error | parsing policies | ❌ |" >> summary.md
            else
              echo "$POLICIES" | jq -c '.[]' | while read -r policy; do
                NAME=$(echo "$policy" | jq -r '.name' 2>/dev/null || echo "unknown")
                VERSION=$(echo "$policy" | jq -r '.version' 2>/dev/null || echo "unknown")
                # Determine status based on job results
                if [ "${{ needs.validate.result }}" = "success" ] && ([ "${{ needs.initialize.outputs.is_release }}" != "true" ] || [ "${{ needs.publish.result }}" = "success" ]); then
                  STATUS="✅ Success"
                else
                  STATUS="❌ Failed"
                fi
                echo "| $NAME | $VERSION | $STATUS |" >> summary.md
              done
            fi
          fi
          echo "" >> summary.md
          echo "### Artifacts" >> summary.md
          echo "- [Validation Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: workflow-summary
          path: summary.md